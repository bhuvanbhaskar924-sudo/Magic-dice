<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Magic Dice — Production (Haptic)</title>
<meta name="theme-color" content="#000000" />
<link rel="manifest" href="manifest.json">

<style>
  :root {
    --bg:#000;
    --dice-bg:#fff;
    --dice-size:36vmin;
    --shadow:0 20px 40px rgba(0,0,0,0.6);
  }
  html,body {
    height:100%; margin:0; background:var(--bg);
    -webkit-user-select:none; user-select:none;
    touch-action:none;
  }
  .stage {
    width:100%; height:100%;
    display:flex; align-items:center; justify-content:center;
    flex-direction:column;
  }
  .dice-wrap {
    width:var(--dice-size); height:var(--dice-size);
    border-radius:14%; background:var(--dice-bg);
    display:flex; align-items:center; justify-content:center;
    box-shadow:var(--shadow);
    transition:transform 0.45s cubic-bezier(.22,.9,.32,1);
    will-change:transform;
  }
  .dice-face {
    font-size:calc(var(--dice-size)*0.42);
    line-height:1;
    user-select:none;
  }
  .hint {
    position:absolute; bottom:22px; width:100%;
    text-align:center; color:#aaa;
    font-family:monospace; font-size:13px;
  }
  .popup-backdrop {
    position:fixed; inset:0;
    background:rgba(0,0,0,0.6);
    display:none; align-items:center; justify-content:center;
    z-index:50;
  }
  .popup {
    background:#111; padding:18px; border-radius:12px; color:#fff;
    min-width:240px; text-align:center;
    box-shadow:0 10px 30px rgba(0,0,0,0.7);
  }
  .num-grid {
    display:grid; grid-template-columns:repeat(3,1fr);
    gap:10px; margin-top:10px;
  }
  .num-btn {
    background:#fff; color:#000; border-radius:8px;
    padding:12px; font-size:18px; border:0; cursor:pointer;
    box-shadow:0 6px 12px rgba(0,0,0,0.3);
  }
</style>
</head>
<body>
  <div class="stage">
    <div class="dice-wrap" id="diceWrap">
      <div class="dice-face" id="diceFace">⚀</div>
    </div>
    <div class="hint">Swipe to roll • Tap ×5 to fix • Hold 3s to activate</div>

    <div class="popup-backdrop" id="popupBackdrop">
      <div class="popup">
        <h3>Choose a number (1–6)</h3>
        <div class="num-grid">
          <button class="num-btn" data-n="1">1</button>
          <button class="num-btn" data-n="2">2</button>
          <button class="num-btn" data-n="3">3</button>
          <button class="num-btn" data-n="4">4</button>
          <button class="num-btn" data-n="5">5</button>
          <button class="num-btn" data-n="6">6</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // CONFIG
  const LONG_PRESS_MS = 3000;
  const MULTITAP_WINDOW = 600;
  const MULTITAP_COUNT = 5;
  const SWIPE_MIN_DISTANCE = 20;
  const THROW_FORCE_MULT = 1.0;
  const SPIN_DURATION = 900;
  const BOUNCE_DURATION = 220;
  const ENABLE_HAPTIC = true;
  const HAPTIC_PATTERN = [30, 40, 30];

  // DOM
  const diceWrap = document.getElementById('diceWrap');
  const diceFace = document.getElementById('diceFace');
  const popupBackdrop = document.getElementById('popupBackdrop');
  const numButtons = document.querySelectorAll('.num-btn');

  const faces = ["⚀","⚁","⚂","⚃","⚄","⚅"];
  let candidateNumber = 0, forcedNumber = 0, forceNext = false;
  let lastTap = 0, tapCount = 0, holdTimer = null, touchStart = null, animating = false;

  function vibrate() {
    if (!ENABLE_HAPTIC) return;
    if ('vibrate' in navigator) {
      navigator.vibrate(HAPTIC_PATTERN);
    }
  }

  function showFace(n) { diceFace.textContent = faces[n-1]; }

  function animateRoll(final, velocity) {
    if (animating) return;
    animating = true;
    const start = performance.now();
    const baseRot = (Math.random()*360)|0;
    const revs = 2 + Math.min(6, Math.max(1, Math.floor((velocity||1)*3)));
    const endRot = baseRot + revs*360 + (Math.random()*40-20);
    const tick = (t) => {
      const p = Math.min(1,(t-start)/SPIN_DURATION);
      const eased = 1 - Math.pow(1-p,3);
      if (p<0.85 && Math.random()<0.3)
        showFace((Math.random()*6|0)+1);
      else
        showFace(final);
      diceWrap.style.transform=`translate(-50%,-50%) rotate(${baseRot+(endRot-baseRot)*eased}deg)`;
      if (p<1) requestAnimationFrame(tick);
      else {
        diceWrap.style.transition=`transform ${BOUNCE_DURATION}ms cubic-bezier(.2,.9,.3,1)`;
        diceWrap.style.transform=`translate(-50%,-50%) rotate(${endRot}deg) scale(1.03)`;
        setTimeout(()=>{diceWrap.style.transform=`translate(-50%,-50%) rotate(${endRot}deg) scale(1)`;diceWrap.style.transition='';animating=false;
          if(forceNext){forceNext=false;forcedNumber=0;candidateNumber=0;}
        },BOUNCE_DURATION);
      }
    };
    requestAnimationFrame(tick);
  }

  function performRoll(vel) {
    if(forceNext && forcedNumber) animateRoll(forcedNumber,vel);
    else animateRoll((Math.random()*6|0)+1,vel);
  }

  function getPoint(e) {
    const t = e.changedTouches?e.changedTouches[0]:e;
    return {x:t.clientX,y:t.clientY,t:e.timeStamp};
  }

  function onStart(e) {
    if(animating) return;
    const now=Date.now();
    tapCount = (now-lastTap<MULTITAP_WINDOW)?tapCount+1:1;
    lastTap=now;
    if(tapCount===MULTITAP_COUNT){ popupBackdrop.style.display='flex'; tapCount=0; }
    touchStart=getPoint(e);
    clearTimeout(holdTimer);
    holdTimer=setTimeout(()=>{
      if(candidateNumber>=1&&candidateNumber<=6){
        forcedNumber=candidateNumber; forceNext=true;
        vibrate(); // magician feedback only
      }
    },LONG_PRESS_MS);
  }

  function onEnd(e) {
    clearTimeout(holdTimer);
    if(!touchStart) return;
    const p=getPoint(e);
    const dx=p.x-touchStart.x, dy=p.y-touchStart.y;
    const dist=Math.hypot(dx,dy), dt=Math.max(8,p.t-touchStart.t);
    touchStart=null;
    if(dist<SWIPE_MIN_DISTANCE){performRoll(0.6);return;}
    performRoll(Math.min(4,dist/dt*THROW_FORCE_MULT*20));
  }

  // Attach events
  document.body.addEventListener('touchstart',onStart,{passive:true});
  document.body.addEventListener('touchend',onEnd,{passive:true});
  document.body.addEventListener('mousedown',onStart);
  document.body.addEventListener('mouseup',onEnd);

  numButtons.forEach(btn=>{
    btn.onclick=()=>{
      candidateNumber=parseInt(btn.dataset.n);
      popupBackdrop.style.display='none';
    };
  });

  showFace((Math.random()*6|0)+1);
})();
</script>
</body>
</html>
